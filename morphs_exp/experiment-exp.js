var arrow = {
    "l12": {
	"horizontal": 25,
	"vertical": -15
    },
    "l23": {
	"horizontal": -10,
	"vertical": 0
    },
    "l34": {
	"horizontal": 0,
	"vertical": -25
    },
    "l45": {
	"horizontal": -10,
	"vertical": -10
    },
    "l56": {
	"horizontal": -15,
	"vertical": -20
    }
};

var spool = {
    "l12": {
	"horizontal": 25,
	"vertical": 25
    },
    "l23": {
	"horizontal": 0,
	"vertical": -25
    },
    "l34": {
	"horizontal": -25,
	"vertical": -25
    }
};

var rectangle = {
    "l12": {
	"horizontal": 40,
	"vertical": 0
    },
    "l23": {
	"horizontal": 0,
	"vertical": 20
    },
    "l34": {
	"horizontal": -40,
	"vertical": 0
    }
};

var steps = {
    "l12": {
	"horizontal": 25,
	"vertical": 0
    },
    "l23": {
	"horizontal": 0,
	"vertical": 25
    },
    "l34": {
	"horizontal": 25,
	"vertical": 0
    },
    "l45": {
	"horizontal": 0,
	"vertical": 10
    },
    "l56": {
	"horizontal": -25,
	"vertical": 0
    },
    "l67": {
	"horizontal": -15,
	"vertical": -10
    }
};

var l_shape = {
    "l12": {
	"horizontal": 0,
	"vertical": 25
    },
    "l23": {
	"horizontal": -25,
	"vertical": 0
    },
    "l34": {
	"horizontal": 50,
	"vertical": 0
    },
    "l45": {
	"horizontal": 0,
	"vertical": -25
    },
    "l56": {
	"horizontal": -50,
	"vertical": 0
    }
};

var z_tetronimo = {
    "l12": {
	"horizontal": 37.5,
	"vertical": 0
    },
    "l23": {
	"horizontal": 0,
	"vertical": -15
    },
    "l34": {
	"horizontal": 15,
	"vertical": 0
    },
    "l45": {
	"horizontal": 0,
	"vertical": 15
    },
    "l56": {
	"horizontal": -30,
	"vertical": 0
    },
    "l67": {
	"horizontal": 0,
	"vertical": -15
    },
    "l78": {
	"horizontal": -15,
	"vertical": 0
    }
};

var almostparallelogram = {
    "l12": {
	"horizontal": 30,
	"vertical": 0
    },
    "l23": {
	"horizontal": -10,
	"vertical": 20
    },
    "l34": {
	"horizontal": -25,
	"vertical": 0
    }
};

var triangle = {
    "l12": {
	"horizontal": 20,
	"vertical": -30
    },
    "l23": {
	"horizontal": -15,
	"vertical": -25
    }
};

var wonkystar = {
     "l12": {
	"horizontal": 25,
	"vertical": 25
    },
    "l23": {
	"horizontal": -15,
	"vertical": 30
    },
    "l34": {
	"horizontal": -20,
	"vertical": -15
    }
}

var chair = {
     "l12": {
	"horizontal": 20,
	"vertical": 20
    },
    "l23": {
	"horizontal": 10,
	"vertical": 10
    },
    "l34": {
	"horizontal": -20,
	"vertical": -20
    },
    "l45": {
	"horizontal": 10,
	"vertical": 10
    },
    "l56": {
	"horizontal": 10,
	"vertical": 10
    },
    "l67": {
	"horizontal": -30,
	"vertical": 0
    }
}

var shaker =  {
     "l12": {
	"horizontal": 5,
	"vertical": 5
    },
    "l23": {
	"horizontal": -5,
	"vertical": 5
    },
    "l34": {
	"horizontal": 5,
	"vertical": 10
    },
    "l45": {
	"horizontal": 10,
	"vertical": 10
    },
    "l56": {
	"horizontal": -10,
	"vertical": 10
    },
    "l67": {
	"horizontal": -5,
	"vertical": 10
    },
 "l78": {
	"horizontal": -5,
	"vertical": -10
    },
 "l89": {
	"horizontal": 10,
	"vertical": -10
    }
}

var cushion = {
    "l12": {
	"horizontal": 20,
	"vertical": 20
    },
    "l23": {
	"horizontal": 10,
	"vertical": 10
    },
    "l34": {
	"horizontal": 0,
	"vertical": 10
    },
    "l45": {
	"horizontal": -30,
	"vertical": 0
    },
    "l56": {
	"horizontal": 0,
	"vertical": -10
    }
}

var sidewayshouse =  {
    "l12": {
	"horizontal": 20,
	"vertical": 0
    },
    "l23": {
	"horizontal": 0,
	"vertical": -20
    },
    "l34": {
	"horizontal": -20,
	"vertical": 0
    },
    "l45": {
	"horizontal": -15,
	"vertical": -10
    }
}

var fakerectangle =  {
    "l12": {
	"horizontal": 0,
	"vertical": 0
    },
    "l23": {
	"horizontal":20,
	"vertical": 0
    },
    "l34": {
	"horizontal": 0,
	"vertical": 20
    },
    "l45": {
	"horizontal": 0,
	"vertical": 0
    },
 "l56": {
	"horizontal": -20,
	"vertical": 0
    }
}

var bowl =  {
    "l12": {
	"horizontal": 30,
	"vertical": 0
    },
    "l23": {
	"horizontal":-10,
	"vertical": 15
    },
    "l34": {
	"horizontal": 5,
	"vertical": 5
    },
    "l45": {
	"horizontal": -20,
	"vertical": 0
    },
 "l56": {
	"horizontal": 5,
	"vertical": -5
    }
}

var flatright = [0.05000000, 0.08461538, 0.11923077, 0.15384615, 0.18846154, 0.22307692, 0.25769231, 0.29230769, 0.32692308, 0.36153846, 0.39615385, 0.43076923, 0.46538462, 0.50000000, 0.53461538, 0.56923077, 0.60384615, 0.63846154, 0.67307692, 0.70769231, 0.74230769, 0.77692308, 0.81153846, 0.84615385, 0.88076923, 0.91538462, 0.95000000];
var flatleft = [0.95000000, 0.91538462, 0.88076923, 0.84615385, 0.81153846, 0.77692308, 0.74230769, 0.70769231, 0.67307692, 0.63846154, 0.60384615, 0.56923077, 0.53461538, 0.50000000, 0.46538462, 0.43076923, 0.39615385, 0.36153846, 0.32692308, 0.29230769, 0.25769231, 0.22307692, 0.18846154, 0.15384615, 0.11923077, 0.08461538, 0.05000000];
var peakedlowerleft = [0.05, 0.05840134, 0.07014782, 0.09167838, 0.10288392, 0.10790845, 0.11149046, 0.12398794, 0.12515774, 0.12726117, 0.14065258, 0.14313109, 0.14868963, 0.15285731, 0.15481087, 0.23155330, 0.24130379, 0.25988427, 0.31188243, 0.33066531, 0.33479215, 0.41709489, 0.43645209, 0.46507358, 0.48531773, 0.58022385, 0.58281485, .95];
var peakedlowerright = [0.95000000, 0.58281485, 0.58022385, 0.48531773, 0.46507358, 0.43645209, 0.41709489, 0.33479215, 0.33066531, 0.31188243, 0.25988427, 0.24130379, 0.23155330, 0.15481087, 0.15285731, 0.14868963, 0.14313109, 0.14065258, 0.12726117, 0.12515774, 0.12398794, 0.11149046, 0.10790845, 0.10288392, 0.09167838, 0.07014782, 0.05840134, 0.05000000];
var peakedupperright = [0.0500000, 0.4171852, 0.4197762, 0.5146823, 0.5349264, 0.5635479, 0.5829051, 0.6652079, 0.6693347, 0.6881176, 0.7401157, 0.7586962, 0.7684467, 0.8451891, 0.8471427, 0.8513104, 0.8568689, 0.8593474, 0.8727388, 0.8748423, 0.8760121, 0.8885095, 0.8920915, 0.8971161, 0.9083216, 0.9298522, 0.9415987, 0.9500000];
var peakedupperleft = [0.9500000, 0.9415987, 0.9298522, 0.9083216, 0.8971161, 0.8920915, 0.8885095, 0.8760121, 0.8748423, 0.8727388, 0.8593474, 0.8568689, 0.8513104, 0.8471427, 0.8451891, 0.7684467, 0.7586962, 0.7401157, 0.6881176, 0.6693347, 0.6652079, 0.5829051, 0.5635479, 0.5349264, 0.5146823, 0.4197762, 0.4171852, 0.0500000];
var gaussright = [.05, 0.1407332, 0.2638165, 0.2915191, 0.3588878, 0.3734829, 0.3763965, 0.3787853, 0.3788022, 0.3933370, 0.4099426, 0.4549313, 0.4554190, 0.4879014, 0.5076645, 0.5197568, 0.5310685, 0.5533390, 0.5608108, 0.5784466, 0.6015973, 0.6046308, 0.6070331, 0.6859006, 0.6920233, 0.9176123, .95];
var gaussleft = [0.9500000, 0.9176123, 0.6920233, 0.6859006, 0.6070331, 0.6046308, 0.6015973, 0.5784466, 0.5608108, 0.5533390, 0.5310685, 0.5197568, 0.5076645, 0.4879014, 0.4554190, 0.4549313, 0.4099426, 0.3933370, 0.3788022, 0.3787853, 0.3763965, 0.3734829, 0.3588878, 0.2915191, 0.2638165, 0.1407332, 0.0500000];

// Display stuff.
var canvasWidth = 900;
var canvasHeight = 450;
var numColumns = 9;  // make sure each set of trial parameters has an distribution array that has length numColumns * numRows.
var numRows = 3;
var leftMargin = 75;
var rightMargin = 75;
var topMargin = 75;

var edgetype = "t"; // "t" for curves, "l" for sharp edges & straight lines.

// Global stuff.
var numberOfQuestionsPerTrial = 6;
var shapes = [[spool, z_tetronimo], [fakerectangle, cushion], [bowl, wonkystar], [arrow, triangle], [sidewayshouse, l_shape], [shaker, chair], [steps, almostparallelogram]];
var adjectives = ["furby", "dibty", "halmy", "wiggy", "grondy", "alby", "hartny"];
var nouns = ["wug", "sarma", "bejeeba", "twan", "pimwit", "barnda", "slubja"];
var colors = ["#FF0000","#00FF00","#0000FF","#FFFF00","#00FFFF","#FF00FF","#FFCC99"];
var distributions = [gaussleft, gaussright, peakedupperright, peakedupperleft, peakedlowerleft, peakedlowerright, flatleft, flatright];
var myTrialAdjectives = shuffle(adjectives);
var myTrialNouns = shuffle(nouns);
var myTrialShapes = shuffle(shapes);
var myTrialColors = shuffle(colors);
var mytrialdistribution = shuffle(distributions);

$(document).ready(function() {
    $(".canvas").attr({width: canvasWidth, height: canvasHeight});
    showSlide("instructions");
    $("#instructions #mustaccept").hide();
});

experiment = {
    data: {},
    intro: function () {
	if (turk.previewMode) {
	    $("#instructions #mustaccept").show();
	} else {
	    showSlide("intro");
	}
    },
    begin: function () {
	showSlide("stage");
	experiment.next(0);
    },
    next: function (trialnum) {
	if (trialnum == shapes.length) {
	    showSlide("language");
	    $("#lgerror").hide();
	    $("#lgsubmit").click(function(){
		lang = $("#lgform").serialize();
		if (lang.length > 5) {
		    lang = lang.slice(3,lang.length);
		    experiment.data["language"] = lang;
		    showSlide("finished");
		    setTimeout(function() { turk.submit(experiment.data) }, 1000);
		}
	    });
	} else { 
	    $(".feedback").hide();
	    $("#stage .moveon").hide();
	    $("#stage .response").hide();
	    $("#stage #bottomtext").hide();
	    $("#nexttrial").hide(); 
	    $(".canvas").hide();
	    papername = "canvas" + trialnum;
	    $("#stage #" + papername).show();
	    var paper = Raphael(papername, canvasWidth, canvasHeight);
	    var onScreenShapes = [];
	    var rightShapeIndex = [0,1].random();
	    var leftShapeIndex;
	    if (rightShapeIndex == 0) {
		leftShapeIndex = 1;
	    } else {
		leftShapeIndex = 0;
	    }
	    var trialorientation;
	    if (mytrialdistribution[trialnum][0] > mytrialdistribution[trialnum][1]) {
		trialorientation = "left";
	    } else {
		trialorientation = "right";
	    }
	    var trialparameters = {
		trialnumber: trialnum,
		adjective: myTrialAdjectives[trialnum],
		noun: myTrialNouns[trialnum],
		leftShape: myTrialShapes[trialnum][leftShapeIndex],
		rightShape: myTrialShapes[trialnum][rightShapeIndex],
		color: myTrialColors[trialnum],
		distribution: mytrialdistribution[trialnum],
		orientation: trialorientation
	    };
 	    var newtext;
	    if (trialnum == 0) { 
		newtext = "<p>One kind of alien artifact are called <b>" + trialparameters.noun + "s</b>.</p>"
	    } else {
		newtext = "<p>Another kind of alien artifact are called <b>" + trialparameters.noun + "s</b>.</p>";
	    }
	    newtext +=  "<p>Some of the " + trialparameters.noun + "s are more <b>" + trialparameters.adjective + "</b> than others.</p> <p>Please take a moment to study these " + trialparameters.noun + "s. When you're ready, click the 'Continue' button below.</p>"
	    $("#bottomtext").show();
	    $("#bottomtext").html(newtext);
	    var xpositions = [];
	    var ypositions = [];
	    for (hor = 0; hor < numColumns; hor++) {
	    	xpositions.push(leftMargin + (hor/numColumns) * (canvasWidth - rightMargin));
	    }
	    for (ver = 0; ver < numRows; ver++) {
	        ypositions.push(topMargin + canvasHeight*3/5 * (ver/numRows));
	    }
	    var indicesbut0and26 = shuffle([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]);
	    var indices = indicesbut0and26;
	    paper.setStart();
	    var ex0posInOSS, ex1posInOSS, comp0posInOSS, comp1posInOSS;
	    var comp0index = [1,2,3].random();
	    var comp1index = [numColumns * numRows - 2, numColumns * numRows - 3, numColumns * numRows - 4].random();
	    var posInOSS = 0;
	    var xspacing = 40;
	    var yspacing = 15;
	    var st = paper.set();
	    var mostTag, leastTag;
	    for (ver = 0; ver < numRows; ver++) { 
		var ypos = ypositions[ver];
		for (hor = 0; hor < numColumns; hor++) {
		    var xpos = xpositions[hor];
		    var idx = indices.shift();
		    var morphProp = trialparameters.distribution[idx];
		    if (idx == 0) {
			if (hor == "left") { // write the tags for having most and least of the property 
			    mostTag = paper.text(xpos + xspacing, ypos + yspacing, "Most " + trialparameters.adjective);
			} else {
			    leastTag = paper.text(xpos + xspacing, ypos + yspacing, "Least " + trialparameters.adjective);
			}
			ex0posInOSS = posInOSS; 
// this and next couple of lines are a possibly overcomplicated way to keep track of randomized objects so we can select the right ones in later demonstrations/questions.
		    }
		    if (idx == 26) {
			if (trialorientation == "right") { // write the tags for having most and least of the property 
			    mostTag = paper.text(xpos + xspacing, ypos + yspacing, "Most " + trialparameters.adjective);
			} else {
			    leastTag = paper.text(xpos + xspacing, ypos + yspacing, "Least " + trialparameters.adjective);
			}
			ex1posInOSS = posInOSS;
		    }
		    if (idx == comp0index) {
			comp0posInOSS = posInOSS;
		    }
		    if (idx == comp1index) {
			comp1posInOSS = posInOSS;
		    }
		    var tmpPath = toPathString(morphBetween(trialparameters.leftShape, trialparameters.rightShape, morphProp), xpos, ypos);
		    var tmpObj = paper.path(tmpPath);
		    onScreenShapes.push([tmpObj,tmpPath,morphProp,idx]);
		    st.push(tmpObj);
		    posInOSS++;
		}
	    }
	    mostTag.attr({"size": 40, "font-family": "Verdana", "font-weight": 1});
	    leastTag.attr({"size": 40, "font-family": "Helvetica", "font-weight": 1});
	    st.attr({stroke: '#000', fill: trialparameters.color});
	    $("#introbutton").show();
	    $("#introbutton").click(function() {
// animation giving subjects information about the array of shapes
		$("#introbutton").unbind("click");
		var examples = [onScreenShapes[ex0posInOSS], onScreenShapes[ex1posInOSS]];
		setTimeout(function() {
		    var example0Path = examples[0][1];
		    var example1Path = examples[1][1];
		    var match0 = example0Path.split(' ');
		    var match1 = example1Path.split(' ');
		    var more, less;
//		    if (match0[1] <= match1[1]) {
		    if (ex0posInOSS%numColumns < ex1posInOSS%numColumns) {
			newPath0 = match0[0] + " " + (canvasWidth/2 - 100) + " " + canvasHeight*4/5;
			newPath1 = match1[0] + " " + (canvasWidth/2 + 100) + " " + canvasHeight*4/5;
			if (examples[0][2] > examples[1][2]) {
			    more = "left"; 
// indicates that the object with more of the property was displayed on the left side of the screen.
			    less = "right";
			} else {
			    more = "right";
			    less = "left";
			}
		    } else {
			newPath0 = match1[0] + " " + (canvasWidth/2 + 100) + " " + canvasHeight*4/5;
			newPath1 = match0[0] + " " + (canvasWidth/2 - 100) + " " + canvasHeight*4/5;
			if (examples[0][2] > examples[1][2]) {
			    more = "right";
			    less = "left";
			} else {
			    more = "left";
			    less = "right";
			}
		    }
		    for (z=3; z < match0.length; z++) {
			newPath0 += " " + match0[z];
		    }
		    for (z=3; z < match1.length; z++) {
			newPath1 += " " + match1[z];
		    }
		    examples[0][0].animate({path: newPath0}, 1000, ">");
		    examples[1][0].animate({path: newPath1}, 1000, ">");
		    var exxtext = "<p> For example, the " + trialparameters.noun + " on the " + more + " is more <b>" + trialparameters.adjective + "</b> than the one on the "+ less + ".</p><p>Please take a look at these two objects, and then click 'Continue' when you're ready to go on.</p>";
		    $("#bottomtext").html(exxtext);
		    $("#introbutton").click(function() {
			$("#introbutton").unbind("click");
			$("#introbutton").hide();
			examples[0][0].animate({path: example0Path}, 1000, ">");
			examples[1][0].animate({path: example1Path}, 1000, ">");
// first test question begins here.
			$("#introbutton").hide();
			var examples1 = [onScreenShapes[comp0posInOSS], onScreenShapes[comp1posInOSS]]; 
			if (comp0posInOSS%numColumns >= comp1posInOSS%numColumns) {
			    examples1 = [examples1[1],examples1[0]]; 
			}
			var q1more, q1less, q1correctanswer, q1otherdirxn;
			var q1comparisondirxn = ["left", "right"].random();
			if (q1comparisondirxn == "left") {
			    q1otherdirxn = "right";
			} else {
			    q1otherdirxn = "left";
			}
			if (examples1[0][2] > examples1[1][2]) {
			    q1more = "left"
			    q1less = "right";
			    if (q1comparisondirxn == "left") {
				q1correctanswer = "yes";
			    } else {
				q1correctanswer = "no";
			    }
			} else {
			    q1more = "right";
			    q1less = "left";
			    if (q1comparisondirxn == "right") {
				q1correctanswer = "yes";
			    } else {
				q1correctanswer = "no";
			    }
			}
			var q1Path0 = examples1[0][1];
			var q1match0 = q1Path0.split(' ');
			q1newPath0 = "M " + (canvasWidth/2 - 100) + " " + canvasHeight*4/5;
			for (z=3; z < q1match0.length; z++) {
			    q1newPath0 += " " + q1match0[z];
			}
			var q1Path1 = examples1[1][1];
			q1newPath1 =  "M " + (canvasWidth/2 + 100) + " " + canvasHeight*4/5;
			var q1match1 = example1Path.split(' ');
			for (z=3; z < q1match1.length; z++) {
			    q1newPath1 += " " + q1match1[z];
			}
			setTimeout(function() {
			    examples1[0][0].animate({path: newPath0}, 1000, ">");
			    examples1[1][0].animate({path: newPath1}, 1000, ">");
			    $("#bottomtext").html("");
			}, 1000);
			setTimeout(function() {
			    var q1text = "<p>Do you think that the " + trialparameters.noun + " on the " + q1comparisondirxn + " is more " + trialparameters.adjective + " than the one on the " + q1otherdirxn + "?</p>";
			    $("#bottomtext").html(q1text);
			    $(".response").show();
			    $("#error").hide();
			    $(".moveon").hide();
			    $("#continue").show();
			    $(".agreement").prop('checked', false);
			    $(".rating").prop('checked', false);
			    startTime = (new Date()).getTime();
			}, 1000);
			$("#continue").click(function() {
			    $("#wronganswer").html("");
			    $("#correctanswer").html("");
			    var q1responseRaw = $("#form").serialize();
			    if (q1responseRaw.length < 21) {
				$("#confidence #error").show();
			    } else {
				$("#continue").unbind("click");
				$("#continue").hide();
				endTime = (new Date()).getTime(); 
				trialparameters.q1rt = endTime - startTime;
				var q1parsed = q1responseRaw.split("&");
				var q1agreement = q1parsed[0].split("=");
				trialparameters.q1response = q1agreement[1];
				var q1rating = q1parsed[1].split("=");
				trialparameters.q1confidence = q1rating[1];
				if (trialparameters.q1response == q1correctanswer) { 
				    trialparameters.q1correctness = "correct"; // record q1 correctness of q1 answer. = true;
				    $(".response").hide();
				    $("#correctanswer").show();
				    $("#correctanswer").html("That's right - the " + trialparameters.noun + " on the " + q1more + " is more " + trialparameters.adjective + ".");
				} else {
				    trialparameters.q1correctness = "incorrect";
				    $(".response").hide();
				    $("#wronganswer").show();
				    $("#wronganswer").html("Sorry, that's not right - actually, the " + trialparameters.noun + " on the " + q1more + " is more " + trialparameters.adjective + ".");
				}
				$("#bottomtext").html("");
				setTimeout(function() {
				    examples1[0][0].animate({path: q1Path0}, 1000, ">");
				    examples1[1][0].animate({path: q1Path1}, 1000, ">");
				    $("#bottomtext").html("Click the 'Continue' button when you're ready to go on.");
				    $("#introbutton").show();
				}, 1000);
				$("#introbutton").click(function() {
				    $("#introbutton").unbind("click");
				    $("#introbutton").hide();
				    $("#bottomtext").hide();
				    $("#wronganswer").hide();
				    $("#correctanswer").hide();
				    experiment.nextquestion(2, trialnum, trialparameters, paper, examples1, onScreenShapes);
				});
			    }  // end of } else {
			}); // end of $("#q1answer").click(function() {
		    }); // end of $("#introexbutton").click(function() {
		}, 500); // end of setTimeout(function() {
	    }); // end of $("#initialdisplay").click(function() {
	}
    }, // end of experiment.next()

    nextquestion: function (qnumber, trialnum, trialpara, paper, examplesseen, shapesonscreen) {
	var candidateexamples = shapesonscreen.cloneArray();
	if (qnumber <= 3) { 
	    // q1 is the comparison; <= 3 so that subjects see two pos-form questions with examples close to the edges.
	    candidateexamples.splice(4, candidateexamples.length - 8); // remove all but the first and last four.
	    candidateexamples.splice(0, 1);       // remove the first and last elements (the initial examples).
	    candidateexamples.splice(candidateexamples.length - 1, 1);  
	} else { 
	    // questions 4-6 will be shapes in the middle of the distribution.
	    candidateexamples = candidateexamples.splice(4, candidateexamples.length - 8);
	}
	candidateexamples = subtract(candidateexamples,examplesseen);
	var qtestExample = candidateexamples.random();
	examplesseen.push(qtestExample);
	var objnum;
	if (trialpara.distribution[0] < trialpara.distribution[26]) { // give the object's absolute position in the order. 1 = least A, 27 = most A.
	    objnum = qtestExample[3];
	} else {
	    objnum = (28 - qtestExample[3]);
	}
	trialpara["q" + qnumber + "ObjAbsolutePosition"] = objnum;
	var article;
	if (trialpara.adjective == "alby") {
	    article = "an";
	} else {
	    article = "a";
	}
	var qtext = "<p>Do you think that this is " + article + " " + trialpara.adjective + " " + trialpara.noun + "?</p>";
	$("#bottomtext").html(qtext);
	$("#bottomtext").show();
	var qtestpath = qtestExample[1];
	var qmatchtest = qtestpath.split(' ');
	qnewPathtest = qmatchtest[0] + " " + (canvasWidth/2) + " " + (canvasHeight*4/5);
	for (z=3; z < qmatchtest.length; z++) {
	    qnewPathtest += " " + qmatchtest[z];
	}
	qtestExample[0].animate({path: qnewPathtest}, 1000, ">");
	setTimeout(function() {
	    startTime = (new Date()).getTime();
	    $(".response").show();
	    $(".agreement").prop('checked', false);
	    $(".rating").prop('checked', false);
	    $("#error").hide();
	    $("#continue").show();
	    trialpara["q" + qnumber + "testlocation"] = qtestExample[2];
	    $("#continue").click(function() {
		var qresponseRaw = $("#form").serialize();
		if (qresponseRaw.length < 21) {
		    $("#confidence #error").show();
		} else {
		    $("#continue").unbind("click");
		    $("#continue").hide();
		    $("#bottomtext").hide();
		    $(".response").hide();
		    endTime = (new Date()).getTime(); 
		    rtindex = "q" + qnumber + "rt";
		    trialpara[rtindex] = endTime - startTime;
		    var qparsed = qresponseRaw.split("&");
		    var qagreement = qparsed[0].split("=");
		    qresponseindex = "q" + qnumber + "response";
		    trialpara[qresponseindex] = qagreement[1];
		    var qrating = qparsed[1].split("=");
		    qconfidenceindex = "q" + qnumber + "confidence";
		    trialpara[qconfidenceindex] = qrating[1];
		    if (qnumber == numberOfQuestionsPerTrial) {
			setTimeout(function () {
			    paper.clear();
			    trialpara.leftShape = name(trialpara.leftShape);
			    trialpara.rightShape = name(trialpara.rightShape);
			    trialpara.distribution = name(trialpara.distribution);
			    experiment.data["trial" + trialnum + "data"] = cloneObject(trialpara);
			    experiment.next(trialnum + 1);
			}, 1000); 
		    } else {
			qtestExample[0].animate({path: qtestpath}, 1000, ">");
			setTimeout(function() {
			    experiment.nextquestion(qnumber + 1, trialnum, trialpara, paper, examplesseen, shapesonscreen);
			}, 1);
		    }
		}
	    });
	}, 1000);
    } 
}

function subtract (array1, array2) {
    var newarray = [];
    var val = false;
    for (i = 0; i < array1.length; i++) {
	for (j = 0; j < array2.length; j++) {
	    if (array1[i] == array2[j]) {
		val = true;
	    }
	}
	if (val == false) {
	    newarray.push(array1[i]);
	}
	val = false;
    }
    return newarray;
} 

function morphBetween(leftSkeleton, rightSkeleton, morphProp) {
    newObj = {};
    var leftclone = cloneObject(leftSkeleton);
    var rightclone = cloneObject(rightSkeleton); 
    var leftsize = Object.keys(leftclone).length;
    var rightsize = Object.keys(rightclone).length;
    if (rightsize > leftsize) {
	for (i = leftsize; i < rightsize; i++) {
	    var newkey = "l" + (i+1) + (i+2);
	    leftclone[newkey] = {
		"horizontal": 0,
		"vertical": 0
	    };
	}
    } else if (leftsize > rightsize) {
	for (i = rightsize; i < leftsize; i++) {
	    var newkey = "l" + (i+1) + (i+2);
	    rightclone[newkey] = {
		"horizontal": 0,
		"vertical": 0
	    };
	}
    }
    for (outerkey in leftclone) {
	newObj[outerkey] = {};
	for (innerkey in leftclone[outerkey]) {
	    newObj[outerkey][innerkey] = leftclone[outerkey][innerkey] + (rightclone[outerkey][innerkey] - leftclone[outerkey][innerkey]) * morphProp; 
	}
    }
    return newObj;   
}

function toPathString(skeletonCopy, xposition, yposition) {
    var newPath;
    newPath =  "M " + xposition + " " + yposition;
    var theKeys = Object.keys(skeletonCopy);
    var indexx;
    var i;
    for (i=1; i <= theKeys.length; i++) {
	indexx = "l" + i + (i+1);
	if (skeletonCopy[indexx]) {
	    newPath = newPath + " " + edgetype + " " + skeletonCopy[indexx]["horizontal"] + " " +  skeletonCopy[indexx]["vertical"];
	}
    }
    newPath = newPath + " z";
    return newPath;
}

function showSlide(id) {
	$(".slide").hide();
	$("#"+id).show();
}

function cloneObject(oldObject) {
    var newObject = jQuery.extend(true, {}, oldObject);
    return newObject;
}

function shuffle(v) { // non-destructive.
    newarray = v.slice(0);
    for(var j, x, i = newarray.length; i; j = parseInt(Math.random() * i), x = newarray[--i], newarray[i] = newarray[j], newarray[j] = x);
    return newarray;
};

function random(a,b) {
    if (typeof b == "undefined") {
	a = a || 2;
	return Math.floor(Math.random()*a);
    } else {
	return Math.floor(Math.random()*(b-a+1)) + a;
    }
}

Array.prototype.random = function() { return this[random(this.length)]; }

Array.prototype.cloneArray = function() { return this.slice(0); }

function name(obj) {
    var sname;
    switch(obj) {
    case gaussleft:
	sname = "gaussleft";
	break;
    case gaussright:
	sname = "gaussright";
	break;
    case peakedupperright:
	sname = "peakedupperright";
	break;
    case peakedupperleft:
	sname = "peakedupperleft";
	break;
    case peakedlowerleft:
	sname = "peakedlowerleft";
	break;
    case peakedlowerright:
	sname = "peakedlowerright";
	break;
    case flatleft:
	sname = "flatleft";
	break;
    case flatright:
	sname = "flatright";
	break;
    case bowl:
	sname = "bowl";
	break;
    case fakerectangle: 
	sname = "fakerectangle";
	break;
    case sidewayshouse:
	sname = "sidewayshouse";
	break;
    case cushion:
	sname = "cushion";
	break;
    case shaker:
	sname = "shaker";
	break;
    case shaker:
	sname = "shaker";
	break;
    case chair:
	sname = "chair";
	break;
    case steps:
	sname = "steps";
	break;
    case spool:
	sname = "spool";
	break;
    case arrow:
	sname = "arrow";
	break;
    case z_tetronimo:
	sname = "z_tetronimo";
	break;
    case l_shape:
	sname = "l_shape";
	break;
    case wonkystar:
	sname = "wonkystar";
	break;
    case triangle:
	sname = "triangle";
	break;
    case almostparallelogram:
	sname = "almostparallelogram";
	break;
    }
    return sname;
}