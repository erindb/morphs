var arrow = {
    "vstart": 15,
//    "scale": .8,
    "l12": {
	"horizontal": 25,
	"vertical": -15
    },
    "l23": {
	"horizontal": -10,
	"vertical": 0
    },
    "l34": {
	"horizontal": 0,
	"vertical": -25
    },
    "l45": {
	"horizontal": -10,
	"vertical": -10
    },
    "l56": {
	"horizontal": -15,
	"vertical": -20
    }
};

var spool = {
    "vstart": 0,
    "l12": {
	"horizontal": 25,
	"vertical": 25
    },
    "l23": {
	"horizontal": 0,
	"vertical": -25
    },
    "l34": {
	"horizontal": -25,
	"vertical": -25
    }
};

var rectangle = {
    "vstart": 0,
    "l12": {
	"horizontal": 40,
	"vertical": 0
    },
    "l23": {
	"horizontal": 0,
	"vertical": 20
    },
    "l34": {
	"horizontal": -40,
	"vertical": 0
    }
};

var steps = {
    "vstart": 0,
    "l12": {
	"horizontal": 25,
	"vertical": 0
    },
    "l23": {
	"horizontal": 0,
	"vertical": 25
    },
    "l34": {
	"horizontal": 25,
	"vertical": 0
    },
    "l45": {
	"horizontal": 0,
	"vertical": 10
    },
    "l56": {
	"horizontal": -25,
	"vertical": 0
    },
    "l67": {
	"horizontal": -15,
	"vertical": -10
    }
};

var l_shape = {
    "vstart": 0,
//    "scale": .8,
    "l12": {
	"horizontal": 0,
	"vertical": 25
    },
    "l23": {
	"horizontal": -25,
	"vertical": 0
    },
    "l34": {
	"horizontal": 50,
	"vertical": 0
    },
    "l45": {
	"horizontal": 0,
	"vertical": -25
    },
    "l56": {
	"horizontal": -50,
	"vertical": 0
    }
};

var z_tetronimo = {
    "vstart": 0,
    "l12": {
	"horizontal": 37.5,
	"vertical": 0
    },
    "l23": {
	"horizontal": 0,
	"vertical": -15
    },
    "l34": {
	"horizontal": 15,
	"vertical": 0
    },
    "l45": {
	"horizontal": 0,
	"vertical": 15
    },
    "l56": {
	"horizontal": -30,
	"vertical": 0
    },
    "l67": {
	"horizontal": 0,
	"vertical": -15
    },
    "l78": {
	"horizontal": -15,
	"vertical": 0
    }
};

var almostparallelogram = {
    "vstart": 0,
    "l12": {
	"horizontal": 30,
	"vertical": 0
    },
    "l23": {
	"horizontal": -10,
	"vertical": 20
    },
    "l34": {
	"horizontal": -25,
	"vertical": 0
    }
};

var triangle = {
    "vstart": 15,
//    "scale": .8,
    "l12": {
	"horizontal": 20,
	"vertical": -30
    },
    "l23": {
	"horizontal": -15,
	"vertical": -25
    }
};

var wonkystar = {
    "vstart": 0,
     "l12": {
	"horizontal": 25,
	"vertical": 25
    },
    "l23": {
	"horizontal": -15,
	"vertical": 30
    },
    "l34": {
	"horizontal": -20,
	"vertical": -15
    }
}

var chair = {
    "vstart": 0,
     "l12": {
	"horizontal": 20,
	"vertical": 20
    },
    "l23": {
	"horizontal": 10,
	"vertical": 10
    },
    "l34": {
	"horizontal": -20,
	"vertical": -20
    },
    "l45": {
	"horizontal": 10,
	"vertical": 10
    },
    "l56": {
	"horizontal": 10,
	"vertical": 10
    },
    "l67": {
	"horizontal": -30,
	"vertical": 0
    }
}

var shaker =  {
    "vstart": 0,
     "l12": {
	"horizontal": 5,
	"vertical": 5
    },
    "l23": {
	"horizontal": -5,
	"vertical": 5
    },
    "l34": {
	"horizontal": 5,
	"vertical": 10
    },
    "l45": {
	"horizontal": 10,
	"vertical": 10
    },
    "l56": {
	"horizontal": -10,
	"vertical": 10
    },
    "l67": {
	"horizontal": -5,
	"vertical": 10
    },
 "l78": {
	"horizontal": -5,
	"vertical": -10
    },
 "l89": {
	"horizontal": 10,
	"vertical": -10
    }
}

var cushion = {
    "vstart": 0,
    "l12": {
	"horizontal": 20,
	"vertical": 20
    },
    "l23": {
	"horizontal": 10,
	"vertical": 10
    },
    "l34": {
	"horizontal": 0,
	"vertical": 10
    },
    "l45": {
	"horizontal": -30,
	"vertical": 0
    },
    "l56": {
	"horizontal": 0,
	"vertical": -10
    }
}

var sidewayshouse =  {
    "vstart": 0,
    "l12": {
	"horizontal": 20,
	"vertical": 0
    },
    "l23": {
	"horizontal": 0,
	"vertical": -20
    },
    "l34": {
	"horizontal": -20,
	"vertical": 0
    },
    "l45": {
	"horizontal": -15,
	"vertical": -10
    }
}

var fakerectangle =  {
    "vstart": 0,
    "l12": {
	"horizontal": 0,
	"vertical": 0
    },
    "l23": {
	"horizontal":20,
	"vertical": 0
    },
    "l34": {
	"horizontal": 0,
	"vertical": 20
    },
    "l45": {
	"horizontal": 0,
	"vertical": 0
    },
 "l56": {
	"horizontal": -20,
	"vertical": 0
    }
}

var bowl =  {
    "vstart": 0,
    "l12": {
	"horizontal": 30,
	"vertical": 0
    },
    "l23": {
	"horizontal":-10,
	"vertical": 15
    },
    "l34": {
	"horizontal": 5,
	"vertical": 5
    },
    "l45": {
	"horizontal": -20,
	"vertical": 0
    },
 "l56": {
	"horizontal": 5,
	"vertical": -5
    }
}

// Display stuff.
var canvasWidth = 960;
var canvasHeight = 400;
var numColumns = 9;  // make sure each set of trial parameters has an distribution array that has length numColumns * numRows.
var numRows = 3;
var leftMargin = 85;
var rightMargin = 125;
var topMargin = 75;

var edgetype = "t"; // "t" for curves, "l" for sharp edges & straight lines.

var shapes = [[spool, z_tetronimo], [fakerectangle, cushion], [bowl, wonkystar], [arrow, triangle], [sidewayshouse, l_shape], [shaker, chair], [steps, almostparallelogram]];
var color = "red";
var distribution = [0.05000000, 0.08461538, 0.11923077, 0.15384615, 0.18846154, 0.22307692, 0.25769231, 0.29230769, 0.32692308, 0.36153846, 0.39615385, 0.43076923, 0.46538462, 0.50000000, 0.53461538, 0.56923077, 0.60384615, 0.63846154, 0.67307692, 0.70769231, 0.74230769, 0.77692308, 0.81153846, 0.84615385, 0.88076923, 0.91538462, 0.95000000];

// Global stuff.
var numberOfQuestionsPerTrial = 6;
var shapes = [[spool, z_tetronimo], [fakerectangle, cushion], [bowl, wonkystar], [arrow, triangle], [sidewayshouse, l_shape], [shaker, chair], [steps, almostparallelogram]];

function name(shape) {
    var sname;
    switch(shape) {
    case bowl:
	sname = "bowl";
	break;
    case fakerectangle: 
	sname = "fakerectangle";
	break;
    case sidewayshouse:
	sname = "sidewayshouse";
	break;
    case cushion:
	sname = "cushion";
	break;
    case shaker:
	sname = "shaker";
	break;
    case shaker:
	sname = "shaker";
	break;
    case chair:
	sname = "chair";
	break;
    case steps:
	sname = "steps";
	break;
    case spool:
	sname = "spool";
	break;
    case arrow:
	sname = "arrow";
	break;
    case z_tetronimo:
	sname = "z_tetronimo";
	break;
    case l_shape:
	sname = "l_shape";
	break;
    case wonkystar:
	sname = "wonkystar";
	break;
    case triangle:
	sname = "triangle";
	break;
    case almostparallelogram:
	sname = "almostparallelogram";
	break;
    }
    return sname;
}

var onScreenShapes= [];

$(document).ready(function() {
    var slideshtml = "";
    for (i = 0; i < shapes.length; i++) {
	slideshtml += "<p id='p" + i + "'><div type='canvas' id='canvas" + i + "'></div>";
    }
    $("#shapes").html(slideshtml);
    $("#shapes").show();
    $(".canvas").attr({width: canvasWidth, height: canvasHeight});
    while (shapes.length != 0) {
	shapesthis = shapes.shift();
	leftShape = shapesthis[0];
	var lsname = name(leftShape);
	pname = "#p" + shapes.length;
	rightShape = shapesthis[1];
	var rsname = name(rightShape);
	papername = "canvas" + shapes.length;
	$(pname).html("Display " + shapes.length + " " + lsname + " " + rsname);
	$(pname).show();
	var paper = Raphael(papername, canvasWidth, canvasHeight);
	var xpositions = [];
	var ypositions = [];
	paper.setStart();
	var idx = 0;
	for (ver = 0; ver < numRows; ver++) { 
	    var ypos = topMargin + canvasHeight*3/5 * (ver/numRows);
	    for (hor = 0; hor < numColumns; hor++) {
		var xpos = leftMargin + (hor/numColumns) * (canvasWidth - rightMargin)
		var morphProp = distribution[idx];
		idx++;
		var tmpPath = toPathString(morphBetween(leftShape, rightShape, morphProp), xpos, ypos);
		var tmpObj = paper.path(tmpPath);
		onScreenShapes.push([tmpObj,tmpPath,morphProp]);
	    }
	}
	var st = paper.setFinish();
	st.attr({stroke: '#000', fill: color});
    }
});

function morphBetween(leftSkeleton, rightSkeleton, morphProp) {
    newObj = {};
    var leftclone = cloneObject(leftSkeleton);
    var rightclone = cloneObject(rightSkeleton); 
    var leftsize = Object.keys(leftclone).length - 1;
    var rightsize = Object.keys(rightclone).length - 1;
    if (rightsize > leftsize) {
	for (i = leftsize; i < rightsize; i++) {
	    var newkey = "l" + (i+1) + (i+2);
	    leftclone[newkey] = {
		"horizontal": 0,
		"vertical": 0
	    };
	}
    } else if (leftsize > rightsize) {
	for (i = rightsize; i < leftsize; i++) {
	    var newkey = "l" + (i+1) + (i+2);
	    rightclone[newkey] = {
		"horizontal": 0,
		"vertical": 0
	    };
	}
    }
    for (outerkey in leftclone) {
	if (outerkey == "vstart") {
	    newObj[outerkey] = morphProp * (leftclone[outerkey] - rightclone[outerkey]);
	} else {
	    newObj[outerkey] = {};
	    for (innerkey in leftclone[outerkey]) {
		newObj[outerkey][innerkey] = leftclone[outerkey][innerkey] + (rightclone[outerkey][innerkey] - leftclone[outerkey][innerkey]) * morphProp; 
	    }
	}
    }
    return newObj;   
}

function toPathString(skeletonCopy, xposition, yposition) {
    var newPath;
    newPath =  "M " + xposition + " " + (yposition + skeletonCopy.vstart);
    var theKeys = Object.keys(skeletonCopy);
    var indexx;
    var i;
    for (i=1; i <= theKeys.length - 2; i++) {
	indexx = "l" + i + (i+1);
	if (skeletonCopy[indexx]) {
	    newPath = newPath + " " + edgetype + " " + (skeletonCopy[indexx]["horizontal"])  + " " +  (skeletonCopy[indexx]["vertical"]);
	}
    }
    newPath = newPath + " z";
    return newPath;
}


function cloneArray(oldArray) {
    var newArray = [];
    for (i = 0; i < oldArray.length; i++) {
	newArray.push(oldArray[i]);
    }
    return newArray;
}

function cloneObject(oldObject) {
    var newObject = jQuery.extend(true, {}, oldObject);
    return newObject;
}
